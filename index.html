<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–ë—Ä–æ–¥–∏–ª–∫–∞ Ultimate Edition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            overflow: hidden;
            touch-action: none;
            position: fixed;
            width: 100%;
            height: 100%;
        }

        .game-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
        }

        .header {
            background: rgba(0, 0, 0, 0.5);
            padding: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            flex-wrap: wrap;
            gap: 5px;
        }

        .player-info {
            text-align: center;
            padding: 4px 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            min-width: 90px;
            font-size: 0.85em;
        }

        .player1-info {
            border: 2px solid #ff6b6b;
        }

        .player2-info {
            border: 2px solid #4ecdc4;
        }

        .score {
            font-size: 1.2em;
            font-weight: bold;
            margin-top: 3px;
        }

        .game-area {
            flex: 1;
            position: relative;
            overflow: hidden;
            margin: 8px;
            border-radius: 12px;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.5);
        }

        canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            padding: 12px;
            gap: 12px;
            background: rgba(0, 0, 0, 0.3);
        }

        .controls.single-player {
            justify-content: center;
        }

        .control-pad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 6px;
            width: 120px;
            height: 120px;
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 8px;
            font-size: 1.3em;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            user-select: none;
            transition: all 0.1s;
            touch-action: manipulation;
        }

        .control-btn:active {
            background: rgba(255, 255, 255, 0.6);
            transform: scale(0.95);
        }

        .control-btn.empty {
            visibility: hidden;
        }

        .player1-controls .control-btn {
            border-color: #ff6b6b;
            background: rgba(255, 107, 107, 0.3);
        }

        .player2-controls .control-btn {
            border-color: #4ecdc4;
            background: rgba(78, 205, 196, 0.3);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            z-index: 100;
            color: white;
            text-align: center;
            padding: 15px;
            overflow-y: auto;
        }

        .modal.hidden {
            display: none;
        }

        h1 {
            font-size: 2em;
            margin: 15px 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        h2 {
            font-size: 1.5em;
            margin: 12px 0;
        }

        h3 {
            font-size: 1.2em;
            margin: 10px 0;
        }

        .section {
            width: 100%;
            max-width: 600px;
            margin: 10px 0;
        }

        .mode-selection, .difficulty-selection, .character-grid, .map-grid {
            display: flex;
            gap: 15px;
            margin: 15px 0;
            flex-wrap: wrap;
            justify-content: center;
        }

        .card {
            background: rgba(255, 255, 255, 0.1);
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 140px;
        }

        .card:hover, .card.selected {
            transform: translateY(-3px);
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.2);
        }

        .card .icon {
            font-size: 2.5em;
            margin-bottom: 8px;
        }

        .character-card {
            width: 80px;
            padding: 15px 10px;
        }

        .character-card .icon {
            font-size: 2em;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1.1em;
            border-radius: 12px;
            cursor: pointer;
            margin: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s;
        }

        button:active {
            transform: scale(0.95);
        }

        button.secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        input {
            padding: 10px 18px;
            font-size: 1em;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            text-align: center;
            margin: 8px 0;
            max-width: 250px;
        }

        input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .stats-panel {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            text-align: left;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chat-box {
            position: fixed;
            bottom: 140px;
            left: 10px;
            right: 10px;
            max-height: 120px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            padding: 8px;
            display: none;
            flex-direction: column;
            gap: 5px;
            overflow-y: auto;
            z-index: 10;
        }

        .chat-box.visible {
            display: flex;
        }

        .chat-message {
            padding: 5px 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            font-size: 0.85em;
        }

        .emoji-bar {
            position: fixed;
            bottom: 140px;
            right: 10px;
            display: flex;
            gap: 5px;
            z-index: 10;
        }

        .emoji-btn {
            width: 35px;
            height: 35px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3em;
            cursor: pointer;
        }

        .particle {
            position: absolute;
            pointer-events: none;
            font-size: 1.5em;
            animation: float-up 1s ease-out forwards;
        }

        @keyframes float-up {
            to {
                transform: translateY(-50px);
                opacity: 0;
            }
        }

        .powerup-indicator {
            position: fixed;
            top: 60px;
            right: 10px;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            font-size: 1.2em;
            display: none;
        }

        .powerup-indicator.active {
            display: block;
            animation: pulse 0.5s infinite;
        }

        .round-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3em;
            color: white;
            text-shadow: 0 0 20px rgba(0,0,0,0.8);
            display: none;
            z-index: 200;
        }

        .round-indicator.show {
            display: block;
            animation: zoomIn 0.5s ease-out;
        }

        @keyframes zoomIn {
            from {
                transform: translate(-50%, -50%) scale(0);
            }
            to {
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .loading {
            font-size: 1.1em;
            margin: 15px 0;
        }

        .winner-text {
            font-size: 1.8em;
            margin: 15px 0;
            font-weight: bold;
        }

        .toggle-switch {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin: 10px;
        }

        .switch {
            position: relative;
            width: 50px;
            height: 26px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 13px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .switch.on {
            background: #4caf50;
        }

        .switch-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: left 0.3s;
        }

        .switch.on .switch-slider {
            left: 27px;
        }
    </style>
</head>
<body>
    <!-- –í–∏–±—ñ—Ä —Ä–µ–∂–∏–º—É -->
    <div class="modal" id="modeSelection">
        <h1>üéÆ –ë—Ä–æ–¥–∏–ª–∫–∞ Ultimate üéÆ</h1>
        <div style="font-size: 2.5em; margin: 15px 0;">ü¶∏ üßô üßù ü¶π</div>
        <h2>–í–∏–±–µ—Ä—ñ—Ç—å —Ä–µ–∂–∏–º –≥—Ä–∏:</h2>
        <div class="mode-selection">
            <div class="card" onclick="selectMode('local')">
                <div class="icon">üì±</div>
                <h3>–õ–æ–∫–∞–ª—å–Ω–∞</h3>
                <div>–ù–∞ –æ–¥–Ω–æ–º—É<br>—Ç–µ–ª–µ—Ñ–æ–Ω—ñ</div>
            </div>
            <div class="card" onclick="selectMode('online')">
                <div class="icon">üåê</div>
                <h3>–û–Ω–ª–∞–π–Ω</h3>
                <div>–ß–µ—Ä–µ–∑<br>—ñ–Ω—Ç–µ—Ä–Ω–µ—Ç</div>
            </div>
        </div>
        
        <div class="section">
            <h3>‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è:</h3>
            <div class="toggle-switch">
                <span>üéµ –ó–≤—É–∫</span>
                <div class="switch on" id="soundToggle" onclick="toggleSound()">
                    <div class="switch-slider"></div>
                </div>
            </div>
        </div>

        <button class="secondary" onclick="showStats()">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
    </div>

    <!-- –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –≥—Ä–∏ -->
    <div class="modal hidden" id="gameSettings">
        <h2>‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –≥—Ä–∏</h2>
        
        <div class="section">
            <h3>üéØ –°–∫–ª–∞–¥–Ω—ñ—Å—Ç—å:</h3>
            <div class="difficulty-selection">
                <div class="card" onclick="selectDifficulty('easy')">
                    <div class="icon">üòä</div>
                    <div>–õ–µ–≥–∫–æ</div>
                </div>
                <div class="card selected" onclick="selectDifficulty('medium')">
                    <div class="icon">üòê</div>
                    <div>–°–µ—Ä–µ–¥–Ω—î</div>
                </div>
                <div class="card" onclick="selectDifficulty('hard')">
                    <div class="icon">üòà</div>
                    <div>–í–∞–∂–∫–æ</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h3>üé≤ –†–µ–∂–∏–º –≥—Ä–∏:</h3>
            <div class="difficulty-selection">
                <div class="card selected" onclick="selectGameMode('time')">
                    <div class="icon">‚è±Ô∏è</div>
                    <div>60 —Å–µ–∫—É–Ω–¥</div>
                </div>
                <div class="card" onclick="selectGameMode('score')">
                    <div class="icon">üéØ</div>
                    <div>–î–æ 100 –æ—á–æ–∫</div>
                </div>
                <div class="card" onclick="selectGameMode('tournament')">
                    <div class="icon">üèÜ</div>
                    <div>–¢—É—Ä–Ω—ñ—Ä (3 —Ä–∞—É–Ω–¥–∏)</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h3>üó∫Ô∏è –ö–∞—Ä—Ç–∞:</h3>
            <div class="map-grid">
                <div class="card character-card selected" onclick="selectMap('forest')">
                    <div class="icon">üå≤</div>
                    <div>–õ—ñ—Å</div>
                </div>
                <div class="card character-card" onclick="selectMap('desert')">
                    <div class="icon">üèúÔ∏è</div>
                    <div>–ü—É—Å—Ç–µ–ª—è</div>
                </div>
                <div class="card character-card" onclick="selectMap('ice')">
                    <div class="icon">‚ùÑÔ∏è</div>
                    <div>–õ—å–æ–¥–æ–≤–∏–∫</div>
                </div>
                <div class="card character-card" onclick="selectMap('volcano')">
                    <div class="icon">üåã</div>
                    <div>–í—É–ª–∫–∞–Ω</div>
                </div>
            </div>
        </div>

        <button onclick="showCharacterSelection()">–î–∞–ª—ñ ‚Üí</button>
        <button class="secondary" onclick="backToModeSelection()">‚Üê –ù–∞–∑–∞–¥</button>
    </div>

    <!-- –í–∏–±—ñ—Ä –ø–µ—Ä—Å–æ–Ω–∞–∂—ñ–≤ -->
    <div class="modal hidden" id="characterSelection">
        <h2>–í–∏–±–µ—Ä—ñ—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂—ñ–≤</h2>
        
        <div class="section">
            <h3 id="selectingPlayerText">ü¶∏ –ì—Ä–∞–≤–µ—Ü—å 1</h3>
            <div class="character-grid" id="characterGrid"></div>
        </div>

        <button onclick="confirmCharacters()">–ü–æ—á–∞—Ç–∏ –≥—Ä—É!</button>
        <button class="secondary" onclick="backToSettings()">‚Üê –ù–∞–∑–∞–¥</button>
    </div>

    <!-- –û–Ω–ª–∞–π–Ω: –≤–≤–µ–¥–µ–Ω–Ω—è —ñ–º–µ–Ω—ñ -->
    <div class="modal hidden" id="nameScreen">
        <h1>üåê –û–Ω–ª–∞–π–Ω —Ä–µ–∂–∏–º</h1>
        <input type="text" id="playerName" placeholder="–í–∞—à–µ —ñ–º'—è" maxlength="15">
        <button onclick="showRoomSelection()">–î–∞–ª—ñ</button>
        <button class="secondary" onclick="backToModeSelection()">–ù–∞–∑–∞–¥</button>
    </div>

    <!-- –û–Ω–ª–∞–π–Ω: –≤–∏–±—ñ—Ä –∫—ñ–º–Ω–∞—Ç–∏ -->
    <div class="modal hidden" id="roomSelection">
        <h2>–í–∏–±–µ—Ä—ñ—Ç—å –∫—ñ–º–Ω–∞—Ç—É</h2>
        <input type="text" id="roomCode" placeholder="–ö–æ–¥ (4 —Å–∏–º–≤–æ–ª–∏)" maxlength="4">
        <button onclick="createRoom()">–°—Ç–≤–æ—Ä–∏—Ç–∏</button>
        <button class="secondary" onclick="joinRoom()">–ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è</button>
        <div class="loading hidden" id="loadingText">–ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è...</div>
        <button class="secondary" onclick="backToSettings()">–ù–∞–∑–∞–¥</button>
    </div>

    <!-- –û—á—ñ–∫—É–≤–∞–Ω–Ω—è -->
    <div class="modal hidden" id="waitingScreen">
        <h2>–û—á—ñ–∫—É–≤–∞–Ω–Ω—è...</h2>
        <div>–ö–æ–¥: <strong id="currentRoomCode"></strong></div>
        <div class="loading">üîÑ –û—á—ñ–∫—É–≤–∞–Ω–Ω—è –≥—Ä–∞–≤—Ü—è...</div>
        <button class="secondary" onclick="cancelWaiting()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="modal hidden" id="statsScreen">
        <h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
        <div class="stats-panel" id="statsContent"></div>
        <button onclick="resetStats()">üóëÔ∏è –°–∫–∏–Ω—É—Ç–∏</button>
        <button class="secondary" onclick="closeStats()">–ó–∞–∫—Ä–∏—Ç–∏</button>
    </div>

    <!-- –ì—Ä–∞ -->
    <div class="game-container hidden" id="gameContainer">
        <div class="header">
            <div class="player-info player1-info">
                <div id="player1Name">ü¶∏ P1</div>
                <div class="score" id="score1">0</div>
            </div>
            <div style="font-size: 1.3em; font-weight: bold;">
                <div id="timer">60</div>
                <div style="font-size: 0.7em;" id="roundInfo"></div>
            </div>
            <div class="player-info player2-info">
                <div id="player2Name">üßô P2</div>
                <div class="score" id="score2">0</div>
            </div>
        </div>

        <div class="game-area">
            <canvas id="gameCanvas"></canvas>
        </div>

        <div class="controls" id="controls"></div>
    </div>

    <div class="powerup-indicator" id="powerupIndicator"></div>
    <div class="round-indicator" id="roundIndicator"></div>
    <div class="chat-box" id="chatBox"></div>
    <div class="emoji-bar hidden" id="emojiBar">
        <div class="emoji-btn" onclick="sendEmoji('üëç')">üëç</div>
        <div class="emoji-btn" onclick="sendEmoji('üòÑ')">üòÑ</div>
        <div class="emoji-btn" onclick="sendEmoji('üò¢')">üò¢</div>
        <div class="emoji-btn" onclick="sendEmoji('üî•')">üî•</div>
    </div>

    <!-- –ö—ñ–Ω–µ—Ü—å –≥—Ä–∏ -->
    <div class="modal hidden" id="gameOver">
        <h2>–ì—Ä–∞ –∑–∞–∫—ñ–Ω—á–µ–Ω–∞!</h2>
        <div class="winner-text" id="winner"></div>
        <p id="finalScores"></p>
        <div id="tournamentResults"></div>
        <button onclick="restartGame()">–ù–æ–≤–∞ –≥—Ä–∞</button>
        <button class="secondary" onclick="backToModeSelection()">–ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é</button>
    </div>

    <script>
        // ============ –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø ============
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        const ALL_CHARACTERS = ['ü¶∏', 'üßô', 'üßù', 'ü¶π', 'üßö', 'ü¶á', 'üêâ', 'ü¶Å', 'üêØ', 'ü¶ä', 'üêº', 'ü¶Ñ'];
        const POWERUPS = {
            speed: { emoji: '‚ö°', duration: 5000 },
            shield: { emoji: 'üõ°Ô∏è', duration: 7000 },
            double: { emoji: 'üåü', duration: 10000 },
            teleport: { emoji: 'üîÑ', duration: 0 }
        };

        const MAPS = {
            forest: { bg: '#2d4a3e', grid: 'rgba(34, 139, 34, 0.2)' },
            desert: { bg: '#c2b280', grid: 'rgba(210, 180, 140, 0.3)' },
            ice: { bg: '#b0e0e6', grid: 'rgba(135, 206, 250, 0.3)' },
            volcano: { bg: '#8b0000', grid: 'rgba(255, 69, 0, 0.2)' }
        };

        // –ì–ª–æ–±–∞–ª—å–Ω–∏–π —Å—Ç–∞–Ω
        let gameMode = null;
        let difficulty = 'medium';
        let selectedGameMode = 'time';
        let selectedMap = 'forest';
        let soundEnabled = true;
        let gameRunning = false;
        let gameLoop = null;
        let syncLoop = null;
        let timeLeft = 60;
        let timerInterval = null;

        // –û–Ω–ª–∞–π–Ω
        let myPlayerId = null;
        let myPlayerName = '';
        let currentRoom = null;
        const storage = window.storage;

        // –ì—Ä–∞–≤—Ü—ñ
        let players = {};
        let selectedCharacters = { player1: null, player2: null };
        let currentSelectingPlayer = 'player1';
        
        // –û–±'—î–∫—Ç–∏
        let coins = [];
        let obstacles = [];
        let powerups = [];
        let particles = [];

        // –¢—É—Ä–Ω—ñ—Ä
        let tournamentMode = false;
        let currentRound = 1;
        let totalRounds = 3;
        let roundScores = [];

        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        let stats = JSON.parse(localStorage.getItem('gameStats') || '{"gamesPlayed": 0, "player1Wins": 0, "player2Wins": 0, "totalCoins": 0, "bestScore": 0}');

        // –°–∫–ª–∞–¥–Ω—ñ—Å—Ç—å
        const DIFFICULTY = {
            easy: { speed: 2, obstacles: 4, powerupChance: 0.3 },
            medium: { speed: 3, obstacles: 6, powerupChance: 0.2 },
            hard: { speed: 4, obstacles: 8, powerupChance: 0.1 }
        };

        // ============ –ó–í–£–ö–ò ============
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx = null;

        function initAudio() {
            if (!audioCtx && soundEnabled) {
                audioCtx = new AudioContext();
            }
        }

        function playSound(freq, duration = 100) {
            if (!soundEnabled || !audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.frequency.value = freq;
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration/1000);
            osc.start();
            osc.stop(audioCtx.currentTime + duration/1000);
        }

        function toggleSound() {
            soundEnabled = !soundEnabled;
            const toggle = document.getElementById('soundToggle');
            toggle.classList.toggle('on');
            if (soundEnabled) initAudio();
        }

        // ============ CANVAS ============
        function resizeCanvas() {
            const gameArea = document.querySelector('.game-area');
            if (gameArea) {
                canvas.width = gameArea.clientWidth;
                canvas.height = gameArea.clientHeight;
            }
        }

        // ============ –£–¢–ò–õ–Ü–¢–ò ============
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function createParticle(x, y, emoji) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.textContent = emoji;
            particle.style.left = x + 'px';
            particle.style.top = y + 'px';
            document.body.appendChild(particle);
            setTimeout(() => particle.remove(), 1000);
        }

        function showRoundIndicator(text) {
            const indicator = document.getElementById('roundIndicator');
            indicator.textContent = text;
            indicator.classList.add('show');
            playSound(800, 200);
            setTimeout(() => indicator.classList.remove('show'), 1500);
        }

        // ============ –í–ò–ë–Ü–† –†–ï–ñ–ò–ú–£ ============
        function selectMode(mode) {
            gameMode = mode;
            initAudio();
            playSound(600, 100);
            document.getElementById('modeSelection').classList.add('hidden');
            document.getElementById('gameSettings').classList.remove('hidden');
        }

        function backToModeSelection() {
            document.querySelectorAll('.modal, .game-container').forEach(el => el.classList.add('hidden'));
            document.getElementById('modeSelection').classList.remove('hidden');
            if (gameLoop) clearInterval(gameLoop);
            if (syncLoop) clearInterval(syncLoop);
            if (timerInterval) clearInterval(timerInterval);
            gameRunning = false;
        }

        // ============ –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø ============
        function selectDifficulty(level) {
            difficulty = level;
            playSound(500, 50);
            document.querySelectorAll('.difficulty-selection .card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.card').classList.add('selected');
        }

        function selectGameMode(mode) {
            selectedGameMode = mode;
            playSound(500, 50);
            document.querySelectorAll('.difficulty-selection .card').forEach((card, idx) => {
                card.classList.remove('selected');
            });
            event.target.closest('.card').classList.add('selected');
            
            if (mode === 'tournament') {
                tournamentMode = true;
                totalRounds = 3;
            } else {
                tournamentMode = false;
            }
        }

        function selectMap(map) {
            selectedMap = map;
            playSound(500, 50);
            document.querySelectorAll('.map-grid .card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.card').classList.add('selected');
        }

        function backToSettings() {
            if (gameMode === 'online') {
                document.getElementById('roomSelection').classList.add('hidden');
                document.getElementById('nameScreen').classList.add('hidden');
            }
            document.getElementById('characterSelection').classList.add('hidden');
            document.getElementById('gameSettings').classList.remove('hidden');
        }

        // ============ –í–ò–ë–Ü–† –ü–ï–†–°–û–ù–ê–ñ–Ü–í ============
        function showCharacterSelection() {
            if (gameMode === 'online') {
                showNameScreen();
                return;
            }
            
            playSound(600, 100);
            document.getElementById('gameSettings').classList.add('hidden');
            document.getElementById('characterSelection').classList.remove('hidden');
            renderCharacterGrid();
        }

        function renderCharacterGrid() {
            const grid = document.getElementById('characterGrid');
            grid.innerHTML = '';
            ALL_CHARACTERS.forEach(char => {
                const card = document.createElement('div');
                card.className = 'card character-card';
                card.innerHTML = `<div class="icon">${char}</div>`;
                card.onclick = () => selectCharacter(char);
                grid.appendChild(card);
            });
        }

        function selectCharacter(char) {
            playSound(700, 80);
            selectedCharacters[currentSelectingPlayer] = char;
            
            if (currentSelectingPlayer === 'player1') {
                currentSelectingPlayer = 'player2';
                document.getElementById('selectingPlayerText').textContent = 'üßô –ì—Ä–∞–≤–µ—Ü—å 2';
                renderCharacterGrid();
            } else {
                confirmCharacters();
            }
        }

        function confirmCharacters() {
            if (!selectedCharacters.player1 || !selectedCharacters.player2) {
                alert('–û–±–µ—Ä—ñ—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂—ñ–≤ –¥–ª—è –æ–±–æ—Ö –≥—Ä–∞–≤—Ü—ñ–≤!');
                return;
            }
            startLocalGame();
        }

        // ============ –õ–û–ö–ê–õ–¨–ù–ê –ì–†–ê ============
        function startLocalGame() {
            playSound(800, 200);
            document.getElementById('characterSelection').classList.add('hidden');
            document.getElementById('gameContainer').classList.remove('hidden');
            resizeCanvas();

            const diffSettings = DIFFICULTY[difficulty];
            
            players = {
                player1: {
                    id: 'player1',
                    name: '–ì—Ä–∞–≤–µ—Ü—å 1',
                    x: 50,
                    y: 50,
                    size: 40,
                    emoji: selectedCharacters.player1,
                    score: 0,
                    dx: 0,
                    dy: 0,
                    speed: diffSettings.speed,
                    powerup: null,
                    powerupEnd: 0
                },
                player2: {
                    id: 'player2',
                    name: '–ì—Ä–∞–≤–µ—Ü—å 2',
                    x: Math.min(300, canvas.width - 100),
                    y: Math.min(300, canvas.height - 100),
                    size: 40,
                    emoji: selectedCharacters.player2,
                    score: 0,
                    dx: 0,
                    dy: 0,
                    speed: diffSettings.speed,
                    powerup: null,
                    powerupEnd: 0
                }
            };

            document.getElementById('player1Name').textContent = selectedCharacters.player1;
            document.getElementById('player2Name').textContent = selectedCharacters.player2;

            const controlsDiv = document.getElementById('controls');
            controlsDiv.innerHTML = `
                <div class="control-pad player1-controls">
                    <div class="control-btn empty"></div>
                    <div class="control-btn" ontouchstart="moveLocalPlayer('player1', 'up')" ontouchend="stopLocalPlayer('player1')">‚Üë</div>
                    <div class="control-btn empty"></div>
                    <div class="control-btn" ontouchstart="moveLocalPlayer('player1', 'left')" ontouchend="stopLocalPlayer('player1')">‚Üê</div>
                    <div class="control-btn empty"></div>
                    <div class="control-btn" ontouchstart="moveLocalPlayer('player1', 'right')" ontouchend="stopLocalPlayer('player1')">‚Üí</div>
                    <div class="control-btn empty"></div>
                    <div class="control-btn" ontouchstart="moveLocalPlayer('player1', 'down')" ontouchend="stopLocalPlayer('player1')">‚Üì</div>
                    <div class="control-btn empty"></div>
                </div>
                <div class="control-pad player2-controls">
                    <div class="control-btn empty"></div>
                    <div class="control-btn" ontouchstart="moveLocalPlayer('player2', 'up')" ontouchend="stopLocalPlayer('player2')">‚Üë</div>
                    <div class="control-btn empty"></div>
                    <div class="control-btn" ontouchstart="moveLocalPlayer('player2', 'left')" ontouchend="stopLocalPlayer('player2')">‚Üê</div>
                    <div class="control-btn empty"></div>
                    <div class="control-btn" ontouchstart="moveLocalPlayer('player2', 'right')" ontouchend="stopLocalPlayer('player2')">‚Üí</div>
                    <div class="control-btn empty"></div>
                    <div class="control-btn" ontouchstart="moveLocalPlayer('player2', 'down')" ontouchend="stopLocalPlayer('player2')">‚Üì</div>
                    <div class="control-btn empty"></div>
                </div>
            `;

            if (tournamentMode) {
                currentRound = 1;
                roundScores = [];
                document.getElementById('roundInfo').textContent = `–†–∞—É–Ω–¥ 1/${totalRounds}`;
                showRoundIndicator('üèÜ –†–∞—É–Ω–¥ 1');
            }

            initGameObjects();
            startGameLoop();
        }

        function moveLocalPlayer(playerId, direction) {
            const player = players[playerId];
            if (!player) return;
            
            const speed = player.powerup === 'speed' ? player.speed * 1.5 : player.speed;
            
            switch(direction) {
                case 'up': player.dx = 0; player.dy = -speed; break;
                case 'down': player.dx = 0; player.dy = speed; break;
                case 'left': player.dx = -speed; player.dy = 0; break;
                case 'right': player.dx = speed; player.dy = 0; break;
            }
        }

        function stopLocalPlayer(playerId) {
            const player = players[playerId];
            if (!player) return;
            player.dx = 0;
            player.dy = 0;
        }

        // ============ –û–ù–õ–ê–ô–ù (—Å–∫–æ—Ä–æ—á–µ–Ω–æ –¥–ª—è —Ä–æ–∑–º—ñ—Ä—É) ============
        function showNameScreen() {
            document.getElementById('gameSettings').classList.add('hidden');
            document.getElementById('nameScreen').classList.remove('hidden');
        }

        function showRoomSelection() {
            const name = document.getElementById('playerName').value.trim();
            if (!name) {
                alert('–í–≤–µ–¥—ñ—Ç—å —ñ–º\'—è!');
                return;
            }
            myPlayerName = name;
            myPlayerId = generateId();
            document.getElementById('nameScreen').classList.add('hidden');
            document.getElementById('roomSelection').classList.remove('hidden');
            document.getElementById('emojiBar').classList.remove('hidden');
        }

        async function createRoom() {
            const roomCode = document.getElementById('roomCode').value.trim().toUpperCase();
            if (!roomCode || roomCode.length !== 4) {
                alert('–ö–æ–¥ –∑ 4 —Å–∏–º–≤–æ–ª—ñ–≤!');
                return;
            }

            try {
                let existingRoom = null;
                try {
                    existingRoom = await storage.get(`room:${roomCode}`, true);
                } catch (e) {}

                if (existingRoom) {
                    alert('–ö—ñ–º–Ω–∞—Ç–∞ —ñ—Å–Ω—É—î!');
                    return;
                }

                currentRoom = roomCode;
                const roomData = {
                    code: roomCode,
                    host: myPlayerId,
                    hostName: myPlayerName,
                    guest: null,
                    guestName: null,
                    settings: { difficulty, gameMode: selectedGameMode, map: selectedMap },
                    createdAt: Date.now()
                };

                await storage.set(`room:${roomCode}`, JSON.stringify(roomData), true);
                document.getElementById('roomSelection').classList.add('hidden');
                document.getElementById('waitingScreen').classList.remove('hidden');
                document.getElementById('currentRoomCode').textContent = roomCode;
                waitForPlayer();
            } catch (error) {
                alert('–ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫—ñ–º–Ω–∞—Ç–∏');
            }
        }

        async function joinRoom() {
            const roomCode = document.getElementById('roomCode').value.trim().toUpperCase();
            if (!roomCode || roomCode.length !== 4) {
                alert('–ö–æ–¥ –∑ 4 —Å–∏–º–≤–æ–ª—ñ–≤!');
                return;
            }

            try {
                const roomDataStr = await storage.get(`room:${roomCode}`, true);
                if (!roomDataStr) {
                    alert('–ö—ñ–º–Ω–∞—Ç–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞!');
                    return;
                }

                const roomData = JSON.parse(roomDataStr.value);
                if (roomData.guest) {
                    alert('–ö—ñ–º–Ω–∞—Ç–∞ –∑–∞–ø–æ–≤–Ω–µ–Ω–∞!');
                    return;
                }

                currentRoom = roomCode;
                roomData.guest = myPlayerId;
                roomData.guestName = myPlayerName;
                await storage.set(`room:${roomCode}`, JSON.stringify(roomData), true);
                
                // –ó–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Ö–æ—Å—Ç–∞
                difficulty = roomData.settings.difficulty;
                selectedGameMode = roomData.settings.gameMode;
                selectedMap = roomData.settings.map;
                
                startOnlineGame(false);
            } catch (error) {
                alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏—î–¥–Ω–∞–Ω–Ω—è');
            }
        }

        async function waitForPlayer() {
            const checkInterval = setInterval(async () => {
                try {
                    const roomDataStr = await storage.get(`room:${currentRoom}`, true);
                    if (roomDataStr) {
                        const roomData = JSON.parse(roomDataStr.value);
                        if (roomData.guest) {
                            clearInterval(checkInterval);
                            startOnlineGame(true);
                        }
                    }
                } catch (error) {}
            }, 1000);
        }

        function cancelWaiting() {
            if (currentRoom) {
                storage.delete(`room:${currentRoom}`, true).catch(e => {});
            }
            backToSettings();
        }

        async function startOnlineGame(isHost) {
            try {
                const roomDataStr = await storage.get(`room:${currentRoom}`, true);
                const roomData = JSON.parse(roomDataStr.value);
                
                document.getElementById('waitingScreen').classList.add('hidden');
                document.getElementById('gameContainer').classList.remove('hidden');
                document.getElementById('chatBox').classList.add('visible');
                
                resizeCanvas();

                const diffSettings = DIFFICULTY[difficulty];
                
                const player1Id = roomData.host;
                const player2Id = roomData.guest;
                
                players[player1Id] = {
                    id: player1Id,
                    name: roomData.hostName,
                    x: 50,
                    y: 50,
                    size: 40,
                    emoji: ALL_CHARACTERS[0],
                    score: 0,
                    dx: 0,
                    dy: 0,
                    speed: diffSettings.speed,
                    powerup: null,
                    powerupEnd: 0
                };
                
                players[player2Id] = {
                    id: player2Id,
                    name: roomData.guestName,
                    x: Math.min(300, canvas.width - 100),
                    y: Math.min(300, canvas.height - 100),
                    size: 40,
                    emoji: ALL_CHARACTERS[1],
                    score: 0,
                    dx: 0,
                    dy: 0,
                    speed: diffSettings.speed,
                    powerup: null,
                    powerupEnd: 0
                };
                
                document.getElementById('player1Name').textContent = roomData.hostName;
                document.getElementById('player2Name').textContent = roomData.guestName;

                const controlsDiv = document.getElementById('controls');
                controlsDiv.className = 'controls single-player';
                controlsDiv.innerHTML = `
                    <div class="control-pad player2-controls">
                        <div class="control-btn empty"></div>
                        <div class="control-btn" ontouchstart="moveOnlinePlayer('up')" ontouchend="stopOnlinePlayer()">‚Üë</div>
                        <div class="control-btn empty"></div>
                        <div class="control-btn" ontouchstart="moveOnlinePlayer('left')" ontouchend="stopOnlinePlayer()">‚Üê</div>
                        <div class="control-btn empty"></div>
                        <div class="control-btn" ontouchstart="moveOnlinePlayer('right')" ontouchend="stopOnlinePlayer()">‚Üí</div>
                        <div class="control-btn empty"></div>
                        <div class="control-btn" ontouchstart="moveOnlinePlayer('down')" ontouchend="stopOnlinePlayer()">‚Üì</div>
                        <div class="control-btn empty"></div>
                    </div>
                `;

                initGameObjects();
                await saveGameState();
                startGameLoop();
                syncLoop = setInterval(syncGame, 100);
            } catch (error) {
                alert('–ü–æ–º–∏–ª–∫–∞ –∑–∞–ø—É—Å–∫—É');
            }
        }

        function moveOnlinePlayer(direction) {
            const player = players[myPlayerId];
            if (!player) return;
            const speed = player.powerup === 'speed' ? player.speed * 1.5 : player.speed;
            switch(direction) {
                case 'up': player.dx = 0; player.dy = -speed; break;
                case 'down': player.dx = 0; player.dy = speed; break;
                case 'left': player.dx = -speed; player.dy = 0; break;
                case 'right': player.dx = speed; player.dy = 0; break;
            }
        }

        function stopOnlinePlayer() {
            const player = players[myPlayerId];
            if (!player) return;
            player.dx = 0;
            player.dy = 0;
        }

        async function saveGameState() {
            if (!currentRoom || !myPlayerId) return;
            try {
                const myPlayer = players[myPlayerId];
                if (!myPlayer) return;
                const playerState = {
                    x: myPlayer.x,
                    y: myPlayer.y,
                    dx: myPlayer.dx,
                    dy: myPlayer.dy,
                    score: myPlayer.score,
                    powerup: myPlayer.powerup,
                    powerupEnd: myPlayer.powerupEnd,
                    lastUpdate: Date.now()
                };
                await storage.set(`game:${currentRoom}:${myPlayerId}`, JSON.stringify(playerState), true);
            } catch (error) {}
        }

        async function syncGame() {
            if (!gameRunning || !currentRoom || gameMode !== 'online') return;
            try {
                await saveGameState();
                const otherPlayerId = Object.keys(players).find(id => id !== myPlayerId);
                if (!otherPlayerId) return;
                const otherStateStr = await storage.get(`game:${currentRoom}:${otherPlayerId}`, true);
                if (otherStateStr) {
                    const otherState = JSON.parse(otherStateStr.value);
                    const otherPlayer = players[otherPlayerId];
                    if (otherPlayer && otherState) {
                        otherPlayer.x = otherState.x;
                        otherPlayer.y = otherState.y;
                        otherPlayer.score = otherState.score;
                        otherPlayer.powerup = otherState.powerup;
                        otherPlayer.powerupEnd = otherState.powerupEnd;
                    }
                }
            } catch (error) {}
        }

        function sendEmoji(emoji) {
            if (gameMode !== 'online') return;
            addChatMessage(`${myPlayerName}: ${emoji}`);
            playSound(600, 50);
        }

        function addChatMessage(msg) {
            const chatBox = document.getElementById('chatBox');
            const msgDiv = document.createElement('div');
            msgDiv.className = 'chat-message';
            msgDiv.textContent = msg;
            chatBox.appendChild(msgDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
            setTimeout(() => msgDiv.remove(), 5000);
        }

        // ============ –Ü–ì–†–û–í–ê –õ–û–ì–Ü–ö–ê ============
        function initGameObjects() {
            coins = [];
            obstacles = [];
            powerups = [];
            const diffSettings = DIFFICULTY[difficulty];
            
            for (let i = 0; i < 8; i++) {
                coins.push(createCoin());
            }
            
            for (let i = 0; i < diffSettings.obstacles; i++) {
                obstacles.push(createObstacle());
            }
        }

        function createCoin() {
            return {
                x: Math.random() * (canvas.width - 30) + 15,
                y: Math.random() * (canvas.height - 30) + 15,
                size: 25,
                emoji: 'ü™ô'
            };
        }

        function createObstacle() {
            return {
                x: Math.random() * (canvas.width - 40) + 20,
                y: Math.random() * (canvas.height - 40) + 20,
                size: 35,
                emoji: 'ü™®'
            };
        }

        function createPowerup() {
            const types = Object.keys(POWERUPS);
            const type = types[Math.floor(Math.random() * types.length)];
            return {
                x: Math.random() * (canvas.width - 30) + 15,
                y: Math.random() * (canvas.height - 30) + 15,
                size: 30,
                type: type,
                emoji: POWERUPS[type].emoji
            };
        }

        function startGameLoop() {
            gameRunning = true;
            
            if (selectedGameMode === 'time') {
                timeLeft = 60;
            } else if (selectedGameMode === 'score') {
                timeLeft = 999;
            }

            gameLoop = setInterval(() => {
                updateGame();
                draw();
            }, 1000 / 60);

            if (selectedGameMode === 'time' || tournamentMode) {
                timerInterval = setInterval(() => {
                    if (selectedGameMode === 'time' || tournamentMode) {
                        timeLeft--;
                        document.getElementById('timer').textContent = timeLeft;
                        
                        if (timeLeft <= 0) {
                            if (tournamentMode && currentRound < totalRounds) {
                                nextRound();
                            } else {
                                endGame();
                            }
                        }
                    }
                }, 1000);
            }

            // Spawn powerups
            setInterval(() => {
                const diffSettings = DIFFICULTY[difficulty];
                if (Math.random() < diffSettings.powerupChance && powerups.length < 2) {
                    powerups.push(createPowerup());
                }
            }, 3000);
        }

        function updateGame() {
            Object.values(players).forEach(player => {
                updatePlayer(player);
                
                // –û–Ω–æ–≤–ª–µ–Ω–Ω—è powerups
                if (player.powerup && Date.now() > player.powerupEnd) {
                    player.powerup = null;
                    if (player.id === 'player1' || player.id === myPlayerId) {
                        document.getElementById('powerupIndicator').classList.remove('active');
                    }
                }
            });

            // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä–µ–∂–∏–º—É –≥—Ä–∏
            if (selectedGameMode === 'score') {
                Object.values(players).forEach(player => {
                    if (player.score >= 100) {
                        endGame();
                    }
                });
            }
        }

        function updatePlayer(player) {
            player.x += player.dx;
            player.y += player.dy;

            if (player.x < 0) player.x = 0;
            if (player.x > canvas.width - player.size) player.x = canvas.width - player.size;
            if (player.y < 0) player.y = 0;
            if (player.y > canvas.height - player.size) player.y = canvas.height - player.size;

            // –ü–µ—Ä–µ—à–∫–æ–¥–∏
            if (player.powerup !== 'shield') {
                for (let obstacle of obstacles) {
                    if (checkCollision(player, obstacle)) {
                        player.x -= player.dx * 2;
                        player.y -= player.dy * 2;
                        player.dx = 0;
                        player.dy = 0;
                        playSound(200, 100);
                    }
                }
            }

            // –ú–æ–Ω–µ—Ç–∏
            for (let i = coins.length - 1; i >= 0; i--) {
                if (checkCollision(player, coins[i])) {
                    const points = player.powerup === 'double' ? 20 : 10;
                    player.score += points;
                    playSound(800, 100);
                    createParticle(coins[i].x, coins[i].y, '+' + points);
                    coins.splice(i, 1);
                    coins.push(createCoin());
                    stats.totalCoins++;
                }
            }

            // Powerups
            for (let i = powerups.length - 1; i >= 0; i--) {
                if (checkCollision(player, powerups[i])) {
                    const powerup = powerups[i];
                    
                    if (powerup.type === 'teleport') {
                        player.x = Math.random() * (canvas.width - player.size);
                        player.y = Math.random() * (canvas.height - player.size);
                    } else {
                        player.powerup = powerup.type;
                        player.powerupEnd = Date.now() + POWERUPS[powerup.type].duration;
                        
                        if (player.id === 'player1' || player.id === myPlayerId) {
                            const indicator = document.getElementById('powerupIndicator');
                            indicator.textContent = powerup.emoji;
                            indicator.classList.add('active');
                        }
                    }
                    
                    playSound(1000, 150);
                    createParticle(powerup.x, powerup.y, powerup.emoji);
                    powerups.splice(i, 1);
                }
            }
        }

        function checkCollision(obj1, obj2) {
            return obj1.x < obj2.x + obj2.size &&
                   obj1.x + obj1.size > obj2.x &&
                   obj1.y < obj2.y + obj2.size &&
                   obj1.y + obj1.size > obj2.y;
        }

        function drawEmoji(emoji, x, y, size) {
            ctx.font = `${size}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(emoji, x + size/2, y + size/2);
        }

        function draw() {
            const mapStyle = MAPS[selectedMap];
            ctx.fillStyle = mapStyle.bg;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.strokeStyle = mapStyle.grid;
            ctx.lineWidth = 1;
            for (let i = 0; i < canvas.width; i += 40) {
                ctx.beginPath();
                ctx.moveTo(i, 0);
                ctx.lineTo(i, canvas.height);
                ctx.stroke();
            }
            for (let i = 0; i < canvas.height; i += 40) {
                ctx.beginPath();
                ctx.moveTo(0, i);
                ctx.lineTo(canvas.width, i);
                ctx.stroke();
            }

            obstacles.forEach(obstacle => {
                drawEmoji(obstacle.emoji, obstacle.x, obstacle.y, obstacle.size);
            });

            coins.forEach(coin => {
                drawEmoji(coin.emoji, coin.x, coin.y, coin.size);
            });

            powerups.forEach(powerup => {
                drawEmoji(powerup.emoji, powerup.x, powerup.y, powerup.size);
            });

            Object.values(players).forEach(player => {
                // –ï—Ñ–µ–∫—Ç shield
                if (player.powerup === 'shield') {
                    ctx.strokeStyle = 'rgba(0, 200, 255, 0.5)';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.arc(player.x + player.size/2, player.y + player.size/2, player.size/2 + 5, 0, Math.PI * 2);
                    ctx.stroke();
                }
                
                drawEmoji(player.emoji, player.x, player.y, player.size);
            });

            const playerIds = Object.keys(players);
            if (playerIds.length >= 2) {
                document.getElementById('score1').textContent = players[playerIds[0]].score;
                document.getElementById('score2').textContent = players[playerIds[1]].score;
            }
        }

        function nextRound() {
            clearInterval(gameLoop);
            clearInterval(timerInterval);
            
            const playerIds = Object.keys(players);
            roundScores.push({
                round: currentRound,
                player1: players[playerIds[0]].score,
                player2: players[playerIds[1]].score
            });
            
            currentRound++;
            showRoundIndicator(`üèÜ –†–∞—É–Ω–¥ ${currentRound}`);
            
            // –°–∫–∏–¥–∞—î–º–æ –æ—á–∫–∏
            Object.values(players).forEach(p => {
                p.score = 0;
                p.x = p.id === playerIds[0] ? 50 : Math.min(300, canvas.width - 100);
                p.y = p.id === playerIds[0] ? 50 : Math.min(300, canvas.height - 100);
                p.dx = 0;
                p.dy = 0;
                p.powerup = null;
            });
            
            document.getElementById('roundInfo').textContent = `–†–∞—É–Ω–¥ ${currentRound}/${totalRounds}`;
            
            initGameObjects();
            timeLeft = 60;
            
            setTimeout(() => {
                startGameLoop();
            }, 2000);
        }

        async function endGame() {
            gameRunning = false;
            clearInterval(gameLoop);
            if (syncLoop) clearInterval(syncLoop);
            clearInterval(timerInterval);

            const gameOver = document.getElementById('gameOver');
            const winner = document.getElementById('winner');
            const finalScores = document.getElementById('finalScores');
            const tournamentResults = document.getElementById('tournamentResults');

            const playerIds = Object.keys(players);
            const player1 = players[playerIds[0]];
            const player2 = players[playerIds[1]];

            stats.gamesPlayed++;
            
            let totalScore1 = player1.score;
            let totalScore2 = player2.score;

            if (tournamentMode) {
                roundScores.push({
                    round: currentRound,
                    player1: player1.score,
                    player2: player2.score
                });
                
                totalScore1 = roundScores.reduce((sum, r) => sum + r.player1, 0);
                totalScore2 = roundScores.reduce((sum, r) => sum + r.player2, 0);
                
                let resultsHTML = '<div class="stats-panel"><h3>–†–µ–∑—É–ª—å—Ç–∞—Ç–∏ —Ç—É—Ä–Ω—ñ—Ä—É:</h3>';
                roundScores.forEach(r => {
                    resultsHTML += `<div class="stat-row"><span>–†–∞—É–Ω–¥ ${r.round}</span><span>${r.player1} : ${r.player2}</span></div>`;
                });
                resultsHTML += `<div class="stat-row"><strong>–í—Å—å–æ–≥–æ:</strong><strong>${totalScore1} : ${totalScore2}</strong></div></div>`;
                tournamentResults.innerHTML = resultsHTML;
            } else {
                tournamentResults.innerHTML = '';
            }

            if (totalScore1 > totalScore2) {
                winner.textContent = `${player1.emoji} ${player1.name} –ø–µ—Ä–µ–º—ñ–≥! üèÜ`;
                winner.style.color = '#ff6b6b';
                stats.player1Wins++;
            } else if (totalScore2 > totalScore1) {
                winner.textContent = `${player2.emoji} ${player2.name} –ø–µ—Ä–µ–º—ñ–≥! üèÜ`;
                winner.style.color = '#4ecdc4';
                stats.player2Wins++;
            } else {
                winner.textContent = 'ü§ù –ù—ñ—á–∏—è!';
                winner.style.color = 'gold';
            }

            finalScores.innerHTML = tournamentMode ? '' : `
                ${player1.emoji} ${player1.name}: ${totalScore1} –æ—á–æ–∫<br>
                ${player2.emoji} ${player2.name}: ${totalScore2} –æ—á–æ–∫
            `;

            if (totalScore1 > stats.bestScore) stats.bestScore = totalScore1;
            if (totalScore2 > stats.bestScore) stats.bestScore = totalScore2;
            
            localStorage.setItem('gameStats', JSON.stringify(stats));
            playSound(1200, 500);

            document.getElementById('gameContainer').classList.add('hidden');
            document.getElementById('chatBox').classList.remove('visible');
            gameOver.classList.remove('hidden');

            if (gameMode === 'online' && currentRoom) {
                try {
                    await storage.delete(`room:${currentRoom}`, true);
                    await storage.delete(`game:${currentRoom}:${myPlayerId}`, true);
                } catch (e) {}
            }
        }

        function restartGame() {
            document.getElementById('gameOver').classList.add('hidden');
            if (gameMode === 'local') {
                currentSelectingPlayer = 'player1';
                showCharacterSelection();
            } else {
                backToModeSelection();
            }
        }

        // ============ –°–¢–ê–¢–ò–°–¢–ò–ö–ê ============
        function showStats() {
            const content = document.getElementById('statsContent');
            content.innerHTML = `
                <div class="stat-row"><span>–í—Å—å–æ–≥–æ —ñ–≥–æ—Ä:</span><span>${stats.gamesPlayed}</span></div>
                <div class="stat-row"><span>–ü–µ—Ä–µ–º–æ–≥ –≥—Ä–∞–≤—Ü—è 1:</span><span>${stats.player1Wins}</span></div>
                <div class="stat-row"><span>–ü–µ—Ä–µ–º–æ–≥ –≥—Ä–∞–≤—Ü—è 2:</span><span>${stats.player2Wins}</span></div>
                <div class="stat-row"><span>–ó—ñ–±—Ä–∞–Ω–æ –º–æ–Ω–µ—Ç:</span><span>${stats.totalCoins}</span></div>
                <div class="stat-row"><span>–ù–∞–π–∫—Ä–∞—â–∏–π —Ä–∞—Ö—É–Ω–æ–∫:</span><span>${stats.bestScore}</span></div>
            `;
            document.getElementById('modeSelection').classList.add('hidden');
            document.getElementById('statsScreen').classList.remove('hidden');
        }

        function closeStats() {
            document.getElementById('statsScreen').classList.add('hidden');
            document.getElementById('modeSelection').classList.remove('hidden');
        }

        function resetStats() {
            if (confirm('–°–∫–∏–Ω—É—Ç–∏ –≤—Å—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É?')) {
                stats = {gamesPlayed: 0, player1Wins: 0, player2Wins: 0, totalCoins: 0, bestScore: 0};
                localStorage.setItem('gameStats', JSON.stringify(stats));
                showStats();
                playSound(400, 100);
            }
        }

        // ============ –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø ============
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        
        // –ê–≤—Ç–æ–∑–≤—É–∫ –ø—Ä–∏ –ø–µ—Ä—à–æ–º—É –∫–ª—ñ–∫—É
        document.addEventListener('click', () => {
            if (!audioCtx && soundEnabled) initAudio();
        }, { once: true });
    </script>
</body>
</html>
